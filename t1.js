
    // filepath: t1.js
    const quizData = {
        "metadata": {
            "title": "Generated Quiz",
            "description": "Auto-generated!",
            "version": "1.0.0",
            "totalQuizzes": 3,
            "validStudentIds": null,
            "passingScore": 70,
            "videoSourceType": "youtube" // Store the video source type
        },
        "quizSchedule": [{"time":264,"quizId":1,"title":"First Quiz","description":"First Quiz"},{"time":475,"quizId":2,"title":"Second Quiz","description":"Second Quiz"},{"time":871,"quizId":3,"title":"Final Quiz","description":"Final Quiz"}],
        "quizzes": {
  "1": {
    "title": "First Quiz",
    "description": "First Quiz",
    "present_items": "ALL",
    "timeLimit": 400,
    "questions": [
      {
        "id": "1.1",
        "question": "Cognitive psychology primarily focuses on:",
        "type": "instructions",
        "correctAnswer": "N/A",
        "points": 0,
        "options": {
          "content": "                            hi <strong>there</strong>"
        },
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "1.2",
        "question": "How did the lecture describe the mind?",
        "type": "multipleChoice",
        "correctAnswer": "b",
        "points": 5,
        "options": [
          "a collection of random thoughts",
          " a factory of representations",
          " a purely logical system",
          " an innate set of behaviors"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "1.3",
        "question": "Which of the following is NOT explicitly mentioned as being involved in processes centered around a single person in cognitive psychology?",
        "type": "multipleChoice",
        "correctAnswer": "d",
        "points": 5,
        "options": [
          "Attention",
          " Perception",
          " Emotion",
          " Physical strength"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "1.4",
        "question": "Simple Reaction Time (SRT) is measured by:",
        "type": "multipleChoice",
        "correctAnswer": "b",
        "points": 5,
        "options": [
          "the time taken to solve a complex problem",
          " the time taken to respond to a single stimulus",
          " the time taken to make a decision",
          " the time taken to recall a memory"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "1.5",
        "question": "Choice Reaction Time (CRT) involves:",
        "type": "multipleChoice",
        "correctAnswer": "c",
        "points": 5,
        "options": [
          "responding to a single simple stimulus",
          " responding to a single stimulus without discrimination",
          " responding to a stimulus and discriminating between different types of stimuli",
          " measuring heart rate during cognitive tasks"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "1.6",
        "question": "Longer reaction times to complex stimuli typically indicate:",
        "type": "multipleChoice",
        "correctAnswer": "c",
        "points": 5,
        "options": [
          "a lack of cognitive ability",
          " a decrease in mental processing speed",
          " a positive correlation between processing time and stimulus complexity",
          " an inability to focus"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      }
    ]
  },
  "2": {
    "title": "Second Quiz",
    "description": "Second Quiz",
    "present_items": 4,
    "timeLimit": 300,
    "questions": [
      {
        "id": "2.1",
        "question": "Who is credited with introducing the concept of forgetting curves? ",
        "type": "multipleChoice",
        "correctAnswer": "a",
        "points": 5,
        "options": [
          "Hermann Ebbinghaus",
          " Dondeers",
          " William James",
          " Sigmund Freud"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "2.2",
        "question": "What was the primary method Ebbinghaus used in his studies?",
        "type": "multipleChoice",
        "correctAnswer": "b",
        "points": 5,
        "options": [
          "Studying other people",
          " Studying himself",
          " Conducting group experiments",
          " Using computer simulations"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "2.3",
        "question": "What did Ebbinghaus initially memorize in his studies?",
        "type": "multipleChoice",
        "correctAnswer": "c",
        "points": 5,
        "options": [
          "Complex sentences",
          " Images",
          " Nonsense words",
          " Mathematical equations"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "2.4",
        "question": "What did Ebbinghaus measure to determine forgetting? ",
        "type": "multipleChoice",
        "correctAnswer": "b",
        "points": 5,
        "options": [
          "The number of words recalled",
          " The time taken to re-learn a list",
          " The number of mistakes made",
          " The speed of speech"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "2.5",
        "question": "What does the term \"savings\" refer to in the context of Ebbinghaus's work? ",
        "type": "multipleChoice",
        "correctAnswer": "c",
        "points": 5,
        "options": [
          "The time taken to initially learn a list",
          " The amount of information retained after a delay",
          " The difference in time between initial learning and re-learning",
          " The number of errors made during re-learning"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "2.6",
        "question": "What does the \"forgetting curve\" illustrate?",
        "type": "multipleChoice",
        "correctAnswer": "c",
        "points": 5,
        "options": [
          "The rate of learning",
          " The effects of sleep on memory",
          " How information decays over time",
          " The impact of stress on cognition"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      }
    ]
  },
  "3": {
    "title": "Final Quiz",
    "description": "Final Quiz",
    "present_items": 4,
    "timeLimit": 500,
    "questions": [
      {
        "id": "3.1",
        "question": "What is a \"paradigm\" in the context of the lecture?",
        "type": "multipleChoice",
        "correctAnswer": "a",
        "points": 5,
        "options": [
          "a system of orienting beliefs",
          " a specific psychological disorder",
          " a type of experimental design",
          " a philosophical theory of mind"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "3.2",
        "question": "What is the \"Cognitive Revolution\" in psychology primarily characterized by",
        "type": "multipleChoice",
        "correctAnswer": "a",
        "points": 5,
        "options": [
          "a shift from studying observable behavior to studying mental processes",
          " a renewed interest in unconscious drives",
          " a focus on genetic influences on behavior",
          " a rejection of experimental methods"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "3.3",
        "question": "What was the main focus of John Watson's approach to psychology?",
        "type": "multipleChoice",
        "correctAnswer": "a",
        "points": 5,
        "options": [
          "observable behavior",
          " unconscious drives",
          " mental representations",
          " genetic predispositions"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "3.4",
        "question": "Where do psychoanalysts believe the crux of our mental issues originate from?",
        "type": "multipleChoice",
        "correctAnswer": "b",
        "points": 5,
        "options": [
          "Observable behavior",
          " unconscious drives",
          " mental representations",
          " genetic predispositions"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      },
      {
        "id": "3.5",
        "question": "Which of these perspectives were associated with Wilhelm Wundt?",
        "type": "multipleChoice",
        "correctAnswer": "b",
        "points": 5,
        "options": [
          "Behaviorism",
          " Structuralism",
          " Psychoanalysis",
          " Cognitivism"
        ],
        "feedback": {
          "correct": "Correct!",
          "incorrect": "Incorrect."
        }
      }
    ]
  }
}
    };



    
    // Load YouTube API
    let player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('myVideo', {
            events: {
                'onStateChange': onPlayerStateChange,
                'onReady': onPlayerReady
            }
        });
    }

    function onPlayerReady(event) {
        // Initialization after player is ready
        initializeQuiz();
    }

    function onPlayerStateChange(event) {
        // Monitor player state
        if (event.data === YT.PlayerState.PLAYING && state.videoPaused) {
            player.pauseVideo();
        }
    }
    

    
// State management
const state = {
    studentId: null,
    quizData: quizData,
    currentQuiz: null,
    quizResults: [],
    videoPaused: false,
    loading: true,
    error: null
};

// DOM Elements
const video = document.getElementById('myVideo');
const quizContainer = document.getElementById('quiz-container');
const submitButton = document.getElementById('submitResults');
const loadingElement = document.getElementById('quiz-loading');
const progressIndicator = document.getElementById('progress-indicator');

// Templates
const errorTemplate = document.getElementById('error-template');
const feedbackTemplate = document.getElementById('feedback-template');

// Utility Functions
function validateStudentId(id, validIds) {
    if (!validIds) return true; // If no IDs loaded, accept any input
    return validIds.includes(id);
}

function shuffleArray(array) {
    const clone = [...array];
    for (let i = clone.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [clone[i], clone[j]] = [clone[j], clone[i]];
    }
    return clone;
}

function showError(message) {
    const errorElement = errorTemplate.content.cloneNode(true);
    errorElement.querySelector('p').textContent = message;
    document.body.appendChild(errorElement);
    setTimeout(() => {
        document.querySelector('.error-message').remove();
    }, 5000);
}

function showLoading(show) {
    state.loading = show;
    loadingElement.style.display = show ? 'block' : 'none';
}

function updateProgress() {
    if (!state.quizData) return;

    const totalQuizzes = state.quizData.metadata.totalQuizzes;
    const completedQuizzes = state.quizResults.reduce((acc, result) => {
        return acc + (result.completed ? 1 : 0);
    }, 0);

    const percentage = (completedQuizzes / totalQuizzes) * 100;
    progressIndicator.style.width = `${percentage}%`;
    progressIndicator.setAttribute('aria-valuenow', percentage);
}

// Quiz Management
async function initializeQuiz() {
    try {
        showLoading(true);

        // Get student ID
        let studentId = prompt('Please enter your student ID');
        if (studentId) {
            if (!validateStudentId(studentId, state.quizData.metadata.validStudentIds)) {
                showError('ID not recognized');
                video.remove(); // Remove video element to terminate quiz
                throw new Error('Invalid student ID');
            }
            state.studentId = studentId;
        } else {
            showError('Student ID is required');
            video.remove(); // Remove video element to terminate quiz
            throw new Error('Student ID required');
        }

        // Initialize event listeners
        initEventListeners();

        showLoading(false);
    } catch (error) {
        showError(error.message);
        console.error('Initialization error:', error);
    }
}

function initEventListeners() {
    submitButton.addEventListener('click', saveResults);

    // Handle different video source types
    if (state.quizData.metadata.videoSourceType === 'youtube') {
        // YouTube video events are handled through the YouTube API
        // Use interval for time tracking since timeupdate events aren't available
        setInterval(handleVideoProgress, 500);
    } else {
        // Standard HTML5 video
        video.addEventListener('play', () => {
            if (state.videoPaused) video.pause();
        });
        video.addEventListener('timeupdate', handleVideoProgress);
    }
}

function getCurrentTime() {
    if (state.quizData.metadata.videoSourceType === 'youtube') {
        return player ? player.getCurrentTime() : 0;
    } else {
        return video ? video.currentTime : 0;
    }
}

function pauseVideo() {
    if (state.quizData.metadata.videoSourceType === 'youtube') {
        if (player) player.pauseVideo();
    } else {
        if (video) video.pause();
    }
}

function playVideo() {
    if (state.quizData.metadata.videoSourceType === 'youtube') {
        if (player) player.playVideo();
    } else {
        if (video) video.play();
    }
}

function handleVideoProgress() {
    if (!state.quizData) return;

    const currentTime = getCurrentTime();

    for (const schedule of state.quizData.quizSchedule) {
        const quiz = state.quizData.quizzes[schedule.quizId];
        if (currentTime >= schedule.time && !quiz.submitted) {
            renderQuiz(schedule.quizId);
            return;
        }
    }

    // Show final submit button if all quizzes completed
    if (currentTime >= state.quizData.quizSchedule[state.quizData.quizSchedule.length - 1].time) {
        const allCompleted = state.quizData.quizSchedule.every(
            schedule => state.quizData.quizzes[schedule.quizId].submitted
        );
        if (allCompleted) {
            submitButton.style.display = 'block';
        }
    }
}

function renderQuiz(quizId) {
    const quiz = state.quizData.quizzes[quizId];
    if (quiz.rendered) return;

    state.currentQuiz = quizId;
    state.videoPaused = true;
    pauseVideo();

    const quizElement = document.getElementById(`quiz-${quizId}`);
    quizContainer.style.display = 'block';
    quizElement.style.display = 'block';

    // Select questions based on present_items
    let questions = quiz.questions;
    if (quiz.present_items !== 'ALL' && typeof quiz.present_items === 'number') {
        questions = shuffleArray(questions).slice(0, quiz.present_items);
    }

    // Render questions
    questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.classList.add('quiz-question');
        questionDiv.setAttribute('data-question-id', question.id);

        questionDiv.innerHTML = `
            <p>${question.question}</p>
            ${renderQuestionInputs(question, index, quizId)}
            <div class="feedback" role="alert"></div>
        `;

        quizElement.appendChild(questionDiv);
    });

    // Add submit button
    const submitBtn = document.createElement('button');
    submitBtn.textContent = `Submit ${quiz.title}`;
    submitBtn.onclick = () => checkAnswers(quizId, questions);
    quizElement.appendChild(submitBtn);

    quiz.rendered = true;
    updateProgress();
}

function renderQuestionInputs(question, index, quizId) {
    switch (question.type) {
        case 'instructions':
            const content = question.options?.content || question.content || question.question || '';
            return `
                <div class="instructions-content" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin: 10px 0; line-height: 1.6;">
                    ${content}
                </div>
            `;

        case 'trueFalse':
            return `
                <div class="option-container">
                    <input type="radio" id="true-${quizId}-${index}" name="q${quizId}-${index}" value="true">
                    <label for="true-${quizId}-${index}">True</label>
                </div>
                <div class="option-container">
                    <input type="radio" id="false-${quizId}-${index}" name="q${quizId}-${index}" value="false">
                    <label for="false-${quizId}-${index}">False</label>
                </div>
            `;

        case 'shortAnswer':
            return `
                <input type="text"
                    name="q${quizId}-${index}"
                    minlength="${question.validation?.minLength || 0}"
                    maxlength="${question.validation?.maxLength || 10000}"
                    ${question.validation?.required ? 'required' : ''}
                >
            `;

        case 'multipleChoice':
            return question.options.map((option, optIndex) => `
                <div class="option-container">
                    <input type="radio"
                        id="opt${optIndex}-${quizId}-${index}"
                        name="q${quizId}-${index}"
                        value="${String.fromCharCode(97 + optIndex)}">
                    <label for="opt${optIndex}-${quizId}-${index}">
                        ${String.fromCharCode(65 + optIndex)}) ${option}
                    </label>
                </div>
            `).join('');

        case 'imageRate':
            // For image rate, the image path is stored in the first element of the options array
            // Clean up the path - remove quotes and normalize slashes
            let imagePath = question.options[0];

            // Remove any surrounding quotes
            imagePath = imagePath.replace(/^["']|["']$/g, '');

            // Convert backslashes to forward slashes
            imagePath = imagePath.replace(/\\/g, '/');

            // Remove any escaped slashes
            imagePath = imagePath.replace(/\//g, '/');

            console.log('Rendering image with path:', imagePath);
            return `
                <div class="image-container">
                    <img src="${imagePath}" alt="Question image" style="max-width: 100%; margin-bottom: 10px;">
                </div>
                <div class="response-container">
                    <textarea
                        name="q${quizId}-${index}"
                        minlength="${question.validation?.minLength || 0}"
                        maxlength="${question.validation?.maxLength || 10000}"
                        ${question.validation?.required ? 'required' : ''}
                        rows="4"
                        style="width: 100%;"
                        placeholder="Enter your response here..."
                    ></textarea>
                </div>
            `;

        case 'sliderRating':
            // For slider rating, we need to extract the slider parameters from the options object
            const sliderOptions = question.options || {};
            const leftValue = sliderOptions.leftValue || 1;
            const rightValue = sliderOptions.rightValue || 5;
            const leftLabel = sliderOptions.leftLabel || 'Weak';
            const rightLabel = sliderOptions.rightLabel || 'Strong';
            const sliderText = sliderOptions.sliderText || 'Rate on the scale below:';

            return `
                <div class="slider-container">
                    <p class="slider-text">${sliderText}</p>
                    <div class="slider-labels">
                        <span class="slider-left-label">${leftLabel} (${leftValue})</span>
                        <span class="slider-right-label">${rightLabel} (${rightValue})</span>
                    </div>
                    <input type="range"
                        name="q${quizId}-${index}"
                        min="${leftValue}"
                        max="${rightValue}"
                        value="${Math.floor((leftValue + rightValue) / 2)}"
                        class="slider-input"
                        style="width: 100%;"
                    >

                </div>
            `;

        default:
            return '';
    }
}

function checkAnswers(quizId, questions) {
    const quiz = state.quizData.quizzes[quizId];
    let allAnswered = true;
    let score = 0;
    let unattemptedQuestions = []; // Track unattempted questions for specific error messaging

    // Check if responses are mandated (default to true for backward compatibility)
    const responsesMandatedElement = document.getElementById('responsesMandatedSetting');
    const responsesMandated = responsesMandatedElement ? responsesMandatedElement.value === 'true' : true;

    questions.forEach((question, index) => {
        const questionElement = document.querySelector(`[data-question-id="${question.id}"]`);
        const feedbackElement = questionElement.querySelector('.feedback');
        let answer;

        if (question.type === 'instructions') {
            // Instructions don't require any input - always considered complete
            // No scoring, no validation needed
            return;
        }

        if (question.type === 'shortAnswer' || question.type === 'imageRate' || question.type === 'sliderRating') {
            // Handle shortAnswer, imageRate, and sliderRating
            let inputElement;

            if (question.type === 'shortAnswer') {
                inputElement = document.querySelector(`input[name="q${quizId}-${index}"]`);
            } else if (question.type === 'imageRate') {
                inputElement = document.querySelector(`textarea[name="q${quizId}-${index}"]`);
            } else if (question.type === 'sliderRating') {
                inputElement = document.querySelector(`input[name="q${quizId}-${index}"]`);
            }

            answer = inputElement ? inputElement.value.trim() : '';

            // Check if responses are mandated and validate accordingly
            if (responsesMandated) {
                // For text inputs (shortAnswer and imageRate), check minimum length requirement
                if (question.type === 'shortAnswer' || question.type === 'imageRate') {
                    const minLength = question.validation?.minLength || 0;
                    if (!answer || answer.length < minLength) {
                        allAnswered = false;
                        unattemptedQuestions.push(question.id);
                        return;
                    }
                }
                // For slider rating, just check if it has been interacted with (default value check)
                else if (question.type === 'sliderRating') {
                    // Slider always has a value, so we consider it answered
                    // Could add more sophisticated logic here if needed
                }
            }

            // Enhanced result object with comprehensive information
            const resultObj = {
                quizId,
                questionId: question.id,
                studentId: state.studentId,
                answer,
                points: question.points,
                questionType: question.type,
                // Enhanced fields for comprehensive output
                questionText: question.question,
                answerText: answer // For these types, answer and answerText are the same
            };

            // Add question-specific details
            if (question.type === 'imageRate' && question.options && question.options.length > 0) {
                resultObj.imagePath = question.options[0];
            } else if (question.type === 'sliderRating' && question.options) {
                resultObj.sliderOptions = question.options;
            }

            state.quizResults.push(resultObj);
        }
         else {
            const selected = document.querySelector(`input[name="q${quizId}-${index}"]:checked`);

            // Check if responses are mandated and question is unanswered
            if (responsesMandated && !selected) {
                allAnswered = false;
                unattemptedQuestions.push(question.id);
                return;
            }

            // If responses are not mandated and no answer selected, skip scoring but continue
            if (!selected) {
                return;
            }

            answer = selected.value;
            const isCorrect = answer === question.correctAnswer;
            score += isCorrect ? question.points : 0;

            // Remove individual feedback display - no longer showing individual MCQ/TF feedback

            // Get the actual text of the selected answer for MCQs
            let answerText = answer;
            if (question.type === 'multipleChoice' && question.options) {
                // Convert letter answer (a, b, c, d) to option index
                const optionIndex = answer.charCodeAt(0) - 97; // 'a' = 0, 'b' = 1, etc.
                if (optionIndex >= 0 && optionIndex < question.options.length) {
                    answerText = question.options[optionIndex];
                }
            } else if (question.type === 'trueFalse') {
                answerText = answer === 'true' ? 'True' : 'False';
            }

            // Enhanced result object with comprehensive information
            const resultObj = {
                quizId,
                questionId: question.id,
                studentId: state.studentId,
                answer,
                correct: isCorrect,
                points: isCorrect ? question.points : 0,
                questionType: question.type,
                // Enhanced fields for comprehensive output
                questionText: question.question,
                answerText: answerText,
                correctAnswer: question.correctAnswer
            };

            // Add options for multiple choice questions
            if (question.type === 'multipleChoice' && question.options) {
                resultObj.questionOptions = question.options;
                // Also include the correct answer text
                const correctIndex = question.correctAnswer.charCodeAt(0) - 97;
                if (correctIndex >= 0 && correctIndex < question.options.length) {
                    resultObj.correctAnswerText = question.options[correctIndex];
                }
            }

            state.quizResults.push(resultObj);
        }
    });

    if (!allAnswered) {
        // Show specific error message with unattempted question IDs
        const errorMessage = unattemptedQuestions.length > 0
            ? `Item(s) ${unattemptedQuestions.join(', ')} not attempted`
            : 'Please answer all questions';
        showError(errorMessage);
        return;
    }

    // Mark quiz as completed
    quiz.submitted = true;
    document.getElementById(`quiz-${quizId}`).style.display = 'none';
    state.videoPaused = false;
    playVideo();

    updateProgress();
}

function saveResults() {
            try {
                // Extract test ID from the current script filename
                const scripts = document.getElementsByTagName('script');
                let testId = 'unknown_quiz';

                // Look for the quiz data script (should be the last script with a .js extension)
                for (let i = scripts.length - 1; i >= 0; i--) {
                    const src = scripts[i].src;
                    if (src && src.endsWith('.js')) {
                        // Extract filename without extension
                        const filename = src.split('/').pop().replace('.js', '');
                        testId = filename;
                        break;
                    }
                }

                // Fallback: try to get from quiz metadata if available
                if (testId === 'unknown_quiz' && state.quizData?.metadata?.title) {
                    testId = state.quizData.metadata.title.toLowerCase().replace(/\s+/g, '_');
                }

                const results = {
                    studentId: state.studentId,
                    timestamp: new Date().toISOString(),
                    testID: testId,
                    results: state.quizResults
                };

                const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quiz_results_${state.studentId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showError('Results saved successfully!');
            } catch (error) {
                showError('Failed to save results');
                console.error('Save error:', error);
            }
        }

// Initialize the quiz system
document.addEventListener('DOMContentLoaded', initializeQuiz);
