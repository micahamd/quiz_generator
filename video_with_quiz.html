<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video with Quiz</title>
    <style>
        /* Basic CSS to control the flow of elements - to be amended later */
        #quiz-container { display: none; margin-top: 20px; }
        .quiz-question { padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; }
    </style>
</head>
<body>

    <video id="myVideo" width="640" height="360" controls>
        <source src="PS203/PS203 Week 1.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div id="quiz-container">
        <div id="quiz-1">
        </div>
    <div id="quiz-2" style="display:none">
            <p>Question 2: What is the largest planet in our solar system?</p>
            <input type="radio" name="q2" value="a">A) Earth <br>
            <input type="radio" name="q2" value="b">B) Jupiter <br>
            <input type="radio" name="q2" value="c">C) Saturn <br>
            <button onclick="checkAnswer(2, 'b')">Submit Answer</button>
        </div>
        </div>
      <div id="results-container"></div>
     <button id = "downloadResults" style="display:none">Download Results</button>

    <script>
        //Video Controls
        const video = document.getElementById('myVideo');
        let studentID = prompt("Please enter your student ID")
        let quizResults = []; // Array to store quiz results
         let videoPaused = false;
        let shownQuizzes = [];
        const quizSchedule = [
            {time: 10, quizId: 1},
            {time: 30, quizId: 2}
        ];
        const quizzes = {
              1: {
                questions: [
                {
                    question: "Question 1: What is the capital of France?",
                    options: ["Berlin", "Paris", "London"],
                    correctAnswer: "b"
                },
                  {
                      question: "Question 2: What is the chemical symbol for water?",
                      options: ["H2O", "CO2", "NaCl"],
                      correctAnswer: "a"
                  }
              ],
                  currentQuestion: 0,
                  answeredQuestions: 0
          },
          2: {
                questions: [],
              currentQuestion: 0
          }
          };
          function renderQuiz(quizId) {
           const quizDiv = document.getElementById(`quiz-${quizId}`);
           quizDiv.innerHTML = '';
             for(let i = 0; i < quizzes[quizId].questions.length; i++){
                 const question = quizzes[quizId].questions[i];
                 const questionDiv = document.createElement('div')
                 questionDiv.classList.add('quiz-question')
                questionDiv.innerHTML = `<p>${question.question}</p>`;
                for (let j = 0; j < question.options.length; j++){
                   questionDiv.innerHTML += `<input type="radio" name="q${quizId}-q${i}" value="${String.fromCharCode(97 + j)}"> ${String.fromCharCode(65 + j)}) ${question.options[j]}<br>`;
                }
                 quizDiv.appendChild(questionDiv)
            }
            // Create only ONE submit button outside the loop
             const submitButton = document.createElement('button')
             submitButton.textContent = 'Submit Answers'
              submitButton.onclick = function() {checkAnswer(quizId)};
             quizDiv.appendChild(submitButton)
         }
        //Quiz Logic
        function checkAnswer(quizNumber) {
            let allQuestionsAnswered = true;
             for (let i = 0; i < quizzes[quizNumber].questions.length; i++){
                  const selectedOption = document.querySelector(`input[name="q${quizNumber}-q${i}"]:checked`);
                   if (!selectedOption) {
                     allQuestionsAnswered = false;
                     break;
                   }
                  if(selectedOption.value === quizzes[quizNumber].questions[i].correctAnswer) {
                    quizResults.push({quiz: quizNumber, studentID: studentID, question: i, result: "correct"});
                  } else {
                     quizResults.push({quiz: quizNumber, studentID: studentID, question: i, result: "incorrect"});
                  }
               }
                if(allQuestionsAnswered) {
                   document.getElementById(`quiz-${quizNumber}`).style.display = 'none';
                    document.getElementById('quiz-container').style.display = 'none';
                    videoPaused = false;
                    video.play();
                  quizzes[quizNumber].answeredQuestions = quizzes[quizNumber].questions.length; // mark all as answered

                   }
                else {
                  alert("Please answer all questions")
                 }
        }
        // Results Logic
         const downloadButton = document.getElementById('downloadResults');
         downloadButton.addEventListener('click', downloadResults);

         function downloadResults () {
           const resultsString = JSON.stringify(quizResults, null, 2); // pretty stringify for readability
           const blob = new Blob([resultsString], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
            a.href = url;
            a.download = 'quiz_results.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
         }
        video.addEventListener('play', function() {
            if (videoPaused) {
               video.pause()
            }
        });
        // Video event listener
       video.addEventListener('timeupdate', function() {
            for (const [index, quiz] of quizSchedule.entries()) {
                if (video.currentTime >= quiz.time && !shownQuizzes.includes(index)) {
                   document.getElementById('quiz-container').style.display = 'block';
                    renderQuiz(quiz.quizId);
                   document.getElementById(`quiz-${quiz.quizId}`).style.display = 'block';
                    video.pause(); // Pause video
                     videoPaused = true;
                   shownQuizzes.push(index);
                   return;
                }
           }
            if(video.currentTime >= 60) { // results at 60s
                 downloadButton.style.display='block'
            }
        });
    </script>
</body>
</html>